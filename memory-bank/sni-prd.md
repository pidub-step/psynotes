Below is the updated Product Requirement Document (PRD) for the Structured Medical Note Formatting feature, revised to incorporate your specific requirements for the frontend changes and the provided example. The updates ensure that the raw transcription remains visible, the structured note is displayed in a new window with editing capabilities, and includes "Save" and "Copy" buttons. The structured note format has also been adjusted to align with the example you provided, notably replacing "Ø" with "Pas d'allergies connues" for allergies.

---

# Product Requirement Document: Structured Medical Note Formatting

## Introduction

This document outlines the requirements for a new feature in the Medical Note Transcription App: the automatic structuring of transcribed medical notes into a predefined format. The feature will process transcribed audio notes in French, generated by the existing transcription service, and output them in a structured format using OpenAI’s GPT models. This enhancement aims to improve the usability of medical notes by providing doctors with a standardized, easily digestible structure, while maintaining access to the raw transcription.

## Feature Overview

The Structured Medical Note Formatting feature will take transcribed text from audio recordings and use an OpenAI GPT model to extract and organize key information into a specific template. The raw transcription will remain visible on the main transcriptions page, while the structured note will be displayed in a new window, where doctors can view, edit, save modifications, and copy the content. This feature enhances the app’s functionality by delivering structured, actionable notes efficiently.

## Requirements

### 1. Input
- **Source**: Transcribed text (in French) from the existing transcription service, using OpenAI’s GPT-4o Transcribe models.
- **Availability**: The transcribed text is stored in the `transcriptions` table in Supabase PostgreSQL after audio processing.

### 2. Processing
- **Model**: Use an OpenAI GPT model (e.g., GPT-4) for text analysis and structuring.
- **Task**: Analyze the transcribed text to extract relevant medical information and format it according to the specified template.
- **Special Handling**:
  - Apply predefined rules for specific cases (e.g., normal physical exam, terminology transformations).
  - Ensure the output adheres strictly to the requested format without inventing information.

### 3. Output
- **Format**: A structured medical note in French, adhering to the following template (aligned with the provided example):
  ```
  Note d’urgence :

  Patient : [sexe, âge]

  Motif : [motif principal de consultation]

  Antécédents médicaux :

  [liste des antécédents médicaux]

  Allergies : [allergies connues, utiliser "Pas d'allergies connues" si aucune]

  Médication actuelle :

  [liste des médicaments actuels]

  Histoire actuelle :

  [description détaillée du problème actuel]

  Examen physique :

  [résultats de l'examen physique - si 'normal' est mentionné, utiliser le format standard]

  Impression clinique :

  [diagnostics probables]

  Plan :

  [examens et traitements prévus]
  ```
- **Storage**: Store the structured note alongside the raw transcription in the Supabase database.

### 4. Special Instructions
- **Normal Physical Exam**:
  - If the transcribed text mentions the physical exam as "normal", use this exact text for the `Examen physique` section:
    ```
    Examen cardiovasculaire normal

    Examen respiratoire normal

    Pas de signes cliniques alarmants
    ```
- **Terminology Transformation**:
  - In the `Antécédents médicaux` section, replace "hypertension" with "HTA".
- **Allergies**:
  - Use "Pas d'allergies connues" in the `Allergies` section if no allergies are mentioned in the transcription, instead of "Ø".
- **Accuracy**:
  - Use only the information present in the transcribed text; do not generate or infer additional details.
  - Follow the exact formatting specified in the template.

## Technical Implementation

The implementation leverages the existing tech stack: Next.js (frontend), Supabase (storage and database), and FastAPI (backend transcription service), with an additional OpenAI GPT API call for structuring.

### 1. Database Changes
- **Modification**: Add a new column to the `transcriptions` table in Supabase PostgreSQL.
  - **Column Name**: `structured_note`
  - **Type**: `text`
  - **Purpose**: Stores the generated structured medical note.

### 2. Backend Changes (FastAPI Service)
- **Process**:
  - After the transcription service stores the raw transcribed text in the `transcriptions` table, trigger an additional step to generate the structured note.
  - Call the OpenAI Chat Completion API (e.g., GPT-4) with the transcribed text and a prompt to produce the structured output.
- **Prompt Example**:
  ```
  You are a medical assistant tasked with structuring a doctor's note into a specific format. Given the following transcribed note, extract and organize the information into the following sections:

  Note d’urgence :

  Patient : [sexe, âge]

  Motif : [motif principal de consultation]

  Antécédents médicaux :

  [liste des antécédents médicaux]

  Allergies : [allergies connues, utiliser "Pas d'allergies connues" si aucune]

  Médication actuelle :

  [liste des médicaments actuels]

  Histoire actuelle :

  [description détaillée du problème actuel]

  Examen physique :

  [résultats de l'examen physique - si 'normal' est mentionné, utiliser le format standard]

  Impression clinique :

  [diagnostics probables]

  Plan :

  [examens et traitements prévus]

  Important instructions:
  - If the physical exam is mentioned as 'normal', use exactly this text for Examen physique: 'Examen cardiovasculaire normal\nExamen respiratoire normal\nPas de signes cliniques alarmants'
  - In the Antécédents médicaux section, transform 'hypertension' to 'HTA'.
  - Use "Pas d'allergies connues" for Allergies if no allergies are mentioned, instead of "Ø".
  - Be precise and use exactly the formats requested.
  - Do not invent information; use only what is present in the note.

  Please provide the structured note.

  Transcribed note: "Un homme de 55 ans qui est venu pour DRS. Ses antécédents, il y a MCAS, MPOC, hypertension, dyslipidémie, pas d'allergie, il prend des médicaments de l'aspirine, du Lipitor. À l'histoire, il y a une DRS depuis 8 heures ce matin qui dure de manière constante avec l'essoufflement, pas de nausées, vomissements, pas de mal de tête. C'est la deuxième fois que ça y arrive en un mois, il n'y a pas de fièvre. L'examen physique est normal, donc je pense à un syndrome coronain aigu, on va donner de l'aspirine puis faire un ECG, une échographie."
  ```
- **Implementation Steps**:
  1. Retrieve the transcribed text from the database after transcription.
  2. Construct the prompt with the transcribed text and send it to the OpenAI API.
  3. Receive the structured note from the API response.
  4. Update the `structured_note` column in the `transcriptions` table with the API output.
- **Error Handling**:
  - Log any API errors (e.g., timeouts, invalid responses) and store an error message or the raw transcription in `structured_note` if structuring fails.

### 3. Frontend Changes (Next.js)
- **Data Fetching**:
  - Modify the existing database query on the transcriptions page to include both the raw transcription (`transcription_text`) and the `structured_note` field.
- **Display**:
  - **Raw Transcription**: On the transcriptions page, display the raw transcription by default, ensuring it remains fully visible and accessible at all times.
  - **Structured Note**: Add a button (e.g., "View Structured Note") next to the raw transcription that opens a new window or modal displaying the `structured_note`.
  - **New Window/Modal**:
    - Display the structured note with clear section headings (e.g., "Patient," "Motif," etc.).
    - Provide an editable text area or fields allowing the doctor to modify the structured note directly in the window.
    - Include a **"Save" button** to save any modifications to the `structured_note` column in the database via an API call to the backend.
    - Include a **"Copy" button** to copy the entire structured note to the clipboard for easy use elsewhere.
- **Responsiveness**:
  - Ensure the new window/modal is responsive and works well on both desktop and mobile devices, consistent with existing UI patterns (e.g., shadcn/ui components).

### 4. User Interface Changes
- **Transcriptions Page**:
  - Display the raw transcription prominently by default (e.g., in a text area or paragraph format).
  - Add a "View Structured Note" button adjacent to the raw transcription.
- **Structured Note Window/Modal**:
  - Present the structured note in a readable, editable format (e.g., a single text area with preserved formatting or separate editable fields per section).
  - Include two buttons at the bottom:
    - **Save**: Updates the `structured_note` in the database with the edited content.
    - **Copy**: Copies the structured note text to the clipboard.
  - Use clear section headings and spacing to enhance readability.
- **Fallback**:
  - If `structured_note` is not yet available or fails to generate, display a message in the window/modal (e.g., "Structuring in progress" or "Structuring failed").

## Testing
- **Test Cases**:
  - Use the provided example transcription to verify accurate structuring:
    - Raw transcription: "Un homme de 55 ans qui est venu pour DRS..."
    - Expected structured note matches the provided example, with "HTA" for "hypertension" and "Pas d'allergies connues" for no allergies.
  - Validate special cases:
    - Physical exam marked as "normal" outputs the predefined text.
    - "Hypertension" transforms to "HTA".
    - No allergies mentioned results in "Pas d'allergies connues".
  - Confirm the output matches the exact format specified.
- **Frontend Functionality**:
  - Verify that the raw transcription remains visible on the transcriptions page.
  - Test opening the structured note in a new window/modal.
  - Test editing the structured note, saving changes, and confirming updates in the database.
  - Test the "Copy" button to ensure the structured note is correctly copied to the clipboard.
- **Cross-Device Testing**:
  - Test on desktop and mobile browsers, especially Safari on iOS, to ensure compatibility and responsiveness.
- **Edge Cases**:
  - Test with transcriptions lacking key information to ensure the model handles incomplete data appropriately.

## Dependencies
- **OpenAI API**: Use the existing OpenAI integration for structuring.
- **Existing Stack**:
  - **Next.js**: Frontend updates for the new window and editing features.
  - **Supabase**: Database storage and updates.
  - **FastAPI**: Backend processing with Python OpenAI client.

## Considerations
- **Accuracy**: Doctors should review and edit the structured note as needed.
- **Performance**: Additional API calls may introduce slight delays; use Supabase Realtime for seamless UI updates.
- **Data Security**: Ensure compliance with existing security measures for sensitive patient data.

## Example Output
For the provided raw transcription:
```
"Un homme de 55 ans qui est venu pour DRS. Ses antécédents, il y a MCAS, MPOC, hypertension, dyslipidémie, pas d'allergie, il prend des médicaments de l'aspirine, du Lipitor. À l'histoire, il y a une DRS depuis 8 heures ce matin qui dure de manière constante avec l'essoufflement, pas de nausées, vomissements, pas de mal de tête. C'est la deuxième fois que ça y arrive en un mois, il n'y a pas de fièvre. L'examen physique est normal, donc je pense à un syndrome coronain aigu, on va donner de l'aspirine puis faire un ECG, une échographie."
```
The structured note should be:
```
Note d’urgence :

Patient : Homme, 55 ans

Motif : Douleur rétrosternale (DRS)

Antécédents médicaux :

MCAS

MPOC

HTA

Dyslipidémie

Allergies : Pas d'allergies connues

Médication actuelle :

Aspirine

Lipitor

Histoire actuelle :

DRS constante depuis environ 8h ce matin

Accompagnée d’essoufflement

Pas de nausées, pas de vomissements, pas de céphalée, pas de fièvre

Deuxième épisode semblable en un mois

Examen physique :

Examen cardiovasculaire normal

Examen respiratoire normal

Pas de signes cliniques alarmants

Impression clinique :

Possible syndrome coronarien aigu

Plan :

Aspirine administrée immédiatement

ECG réalisé

Échographie cardiaque demandée

Surveillance étroite à l’urgence

Consultation cardiologique au besoin
```

---

This revised PRD reflects your requirements: the raw transcription remains visible on the transcriptions page, the structured note opens in a new window with editing capabilities, and includes "Save" and "Copy" buttons. The format aligns with your example, ensuring consistency and usability for doctors.